From: Sebastian Ott <sebott@linux.vnet.ibm.com>
Subject: s390/pci: improve state check when processing hotplug events
Patch-mainline: v3.16-rc1
Git-commit: ca25f564c484b4f32eec1e667926dcf87ec03234
References: bnc#946214, LTC#130628

Description:  s390/pci: fix handling of hotplug events
Symptom:      A pci function added to the system via hotplug
              might not be usable to Linux. In rare situations
              the kernel might crash.
Problem:      Linux does not handle all hotplug events correctly.
Solution:     Handle hotplug events correctly.
Reproduction: pci hotplug

Upstream-Description:

              s390/pci: improve state check when processing hotplug events

              Processing pci hotplug events can fail when a pci function is in an
              unexpected state. This can happen when we already processed the
              change associated with the hotplug event (especially when receiving
              hotplug events during early boot).
              Just ignore the event in this case.

              Reviewed-by: Gerald Schaefer <gerald.schaefer@de.ibm.com>
              Signed-off-by: Sebastian Ott <sebott@linux.vnet.ibm.com>
              Signed-off-by: Martin Schwidefsky <schwidefsky@de.ibm.com>


Signed-off-by: Sebastian Ott <sebott@linux.vnet.ibm.com>
Acked-by: John Jolly <jjolly@suse.de>
---
 arch/s390/pci/pci_event.c |    5 +++--
 1 file changed, 3 insertions(+), 2 deletions(-)

--- a/arch/s390/pci/pci_event.c
+++ b/arch/s390/pci/pci_event.c
@@ -76,7 +76,7 @@ static void __devinit __zpci_event_avail
 
 	switch (ccdf->pec) {
 	case 0x0301: /* Standby -> Configured */
-		if (!zdev || zdev->state == ZPCI_FN_STATE_CONFIGURED)
+		if (!zdev || zdev->state != ZPCI_FN_STATE_STANDBY)
 			break;
 		zdev->state = ZPCI_FN_STATE_CONFIGURED;
 		zdev->fh = ccdf->fh;
@@ -86,7 +86,8 @@ static void __devinit __zpci_event_avail
 		pci_rescan_bus(zdev->bus);
 		break;
 	case 0x0302: /* Reserved -> Standby */
-		clp_add_pci_device(ccdf->fid, ccdf->fh, 0);
+		if (!zdev)
+			clp_add_pci_device(ccdf->fid, ccdf->fh, 0);
 		break;
 	case 0x0303: /* Deconfiguration requested */
 		if (pdev)
