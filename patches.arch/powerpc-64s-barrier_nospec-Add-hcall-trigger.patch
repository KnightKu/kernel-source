From 48bc5a0ea44af6a1cc1a5b5faaa6ab2d1fa998e2 Mon Sep 17 00:00:00 2001
From: Michal Suchanek <msuchanek@suse.de>
Date: Fri, 9 Mar 2018 18:48:38 +0100
Subject: [PATCH 13/14] powerpc/64s: barrier_nospec: Add hcall trigger

References: bsc#1068032, bsc#1080157
Patch-mainline: submitted http://patchwork.ozlabs.org/project/linuxppc-dev/list/?series=34040

Adapted from the RFI implementation

Signed-off-by: Michal Suchanek <msuchanek@suse.de>
---
 arch/powerpc/platforms/pseries/mobility.c |  2 +-
 arch/powerpc/platforms/pseries/pseries.h  |  2 +-
 arch/powerpc/platforms/pseries/setup.c    | 30 +++++++++++++++++++++---------
 3 files changed, 23 insertions(+), 11 deletions(-)

diff --git a/arch/powerpc/platforms/pseries/mobility.c b/arch/powerpc/platforms/pseries/mobility.c
index ac98e83a5eb2..35776775daa4 100644
--- a/arch/powerpc/platforms/pseries/mobility.c
+++ b/arch/powerpc/platforms/pseries/mobility.c
@@ -349,7 +349,7 @@ void post_mobility_fixup(void)
 			"failed: %d\n", rc);
 
 	/* Possibly switch to a new RFI flush type */
-	pseries_setup_rfi_flush();
+	pseries_setup_rfi_nospec();
 
 	return;
 }
diff --git a/arch/powerpc/platforms/pseries/pseries.h b/arch/powerpc/platforms/pseries/pseries.h
index c02267557e7a..0eb52bd581b6 100644
--- a/arch/powerpc/platforms/pseries/pseries.h
+++ b/arch/powerpc/platforms/pseries/pseries.h
@@ -100,6 +100,6 @@ static inline unsigned long cmo_get_page_size(void)
 
 int dlpar_workqueue_init(void);
 
-void pseries_setup_rfi_flush(void);
+void pseries_setup_rfi_nospec(void);
 
 #endif /* _PSERIES_PSERIES_H */
diff --git a/arch/powerpc/platforms/pseries/setup.c b/arch/powerpc/platforms/pseries/setup.c
index 5126385148cb..97c9e92dc53d 100644
--- a/arch/powerpc/platforms/pseries/setup.c
+++ b/arch/powerpc/platforms/pseries/setup.c
@@ -494,11 +494,13 @@ static void init_cpu_char_feature_flags(struct h_cpu_char_result *result)
 		security_ftr_clear(SEC_FTR_BNDS_CHK_SPEC_BAR);
 }
 
-void pseries_setup_rfi_flush(void)
+void pseries_setup_rfi_nospec(void)
 {
 	struct h_cpu_char_result result;
-	enum l1d_flush_type types;
-	bool enable;
+	enum l1d_flush_type flush_types;
+	enum spec_barrier_type barrier_type;
+	bool flush_enable;
+	bool barrier_enable;
 	long rc;
 
 	rc = plpar_get_cpu_characteristics(&result);
@@ -511,18 +513,28 @@ void pseries_setup_rfi_flush(void)
 	 */
 	security_ftr_clear(SEC_FTR_L1D_FLUSH_HV);
 
-	types = L1D_FLUSH_FALLBACK;
+	flush_types = L1D_FLUSH_FALLBACK;
 
 	if (security_ftr_enabled(SEC_FTR_L1D_FLUSH_TRIG2))
-		types |= L1D_FLUSH_MTTRIG;
+		flush_types |= L1D_FLUSH_MTTRIG;
 
 	if (security_ftr_enabled(SEC_FTR_L1D_FLUSH_ORI30))
-		types |= L1D_FLUSH_ORI;
+		flush_types |= L1D_FLUSH_ORI;
 
-	enable = security_ftr_enabled(SEC_FTR_FAVOUR_SECURITY) && \
+	flush_enable = security_ftr_enabled(SEC_FTR_FAVOUR_SECURITY) && \
 		 security_ftr_enabled(SEC_FTR_L1D_FLUSH_PR);
 
-	setup_rfi_flush(types, enable);
+	/* no fallback available if the firmware does not tell us */
+	barrier_type = SPEC_BARRIER_NONE;
+
+	if (security_ftr_enabled(SEC_FTR_SPEC_BAR_ORI31))
+		barrier_type = SPEC_BARRIER_ORI;
+
+	barrier_enable = security_ftr_enabled(SEC_FTR_FAVOUR_SECURITY) && \
+		 security_ftr_enabled(SEC_FTR_BNDS_CHK_SPEC_BAR);
+
+	setup_barrier_nospec(barrier_type, barrier_enable);
+	setup_rfi_flush(flush_types, flush_enable);
 }
 
 #ifdef CONFIG_PCI_IOV
@@ -698,7 +710,7 @@ static void __init pSeries_setup_arch(void)
 
 	fwnmi_init();
 
-	pseries_setup_rfi_flush();
+	pseries_setup_rfi_nospec();
 
 	/* By default, only probe PCI (can be overridden by rtas_pci) */
 	pci_add_flags(PCI_PROBE_ONLY);
-- 
2.13.6

