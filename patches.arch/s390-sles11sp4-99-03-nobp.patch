From: Martin Schwidefsky <schwidefsky@de.ibm.com>
Patch-mainline: Not yet, under development
Subject: s390/spinlock: add ppa to system call path

Signed-off-by: Martin Schwidefsky <schwidefsky@de.ibm.com>
Signed-off-by: Jiri Kosina <jkosina@suse.cz>
---
 arch/s390/kernel/alternative.c |   13 +++++++++++++
 arch/s390/kernel/entry.S       |   32 ++++++++++++++++++++++++++++++++
 arch/s390/kernel/vmlinux.lds.S |    3 +++
 3 files changed, 48 insertions(+)

--- a/arch/s390/kernel/alternative.c
+++ b/arch/s390/kernel/alternative.c
@@ -14,6 +14,19 @@
 
 early_param("noaltinstr", disable_alternative_instructions);
 
+extern struct alt_instr __alt_nobp[], __alt_nobp_end[];
+static int __init nobp_setup(char *str)
+{
+	bool enabled;
+	int rc;
+
+	rc = strtobool(str, &enabled);
+	if (!rc && enabled)
+		apply_alternatives(__alt_nobp, __alt_nobp_end);
+	return rc;
+}
+__setup("nobp=", nobp_setup);
+
 struct brcl_insn {
 	u16 opc;
 	s32 disp;
--- a/arch/s390/kernel/entry.S
+++ b/arch/s390/kernel/entry.S
@@ -188,6 +188,34 @@
 	ssm	__SF_EMPTY(%r15)
 	.endm
 
+	.macro BPOFF
+	.pushsection .altinstr_replacement, "ax"
+0:	.long	0xb2e8c000	# FIXME: PPA 12 correct ?
+	.popsection
+1:	.long	0x47000000
+	.pushsection .altnobp, "a"
+        .long 1b - .
+	.long 0b - .
+	.word 49		# FIXME: facility bit 49 correct ?
+	.byte 4
+	.byte 4
+	.popsection
+	.endm
+
+	.macro BPON
+	.pushsection .altinstr_replacement, "ax"
+0:	.long	0xb2e8d000	# FIXME: PPA 13 correct ?
+	.popsection
+1:	.long	0x47000000
+	.pushsection .altnobp, "a"
+        .long 1b - .
+	.long 0b - .
+	.word 49		# FIXME: facility bit 49 correct ?
+	.byte 4
+	.byte 4
+	.popsection
+	.endm
+
 	.section .kprobes.text, "ax"
 
 /*
@@ -255,7 +283,9 @@
 	mvc	SP_ARGS(4,%r15),SP_R7(%r15)
 	l	%r8,0(%r7,%r10)	  # get system call addr.
 	bnz	BASED(sysc_tracesys)
+	BPOFF
 	basr	%r14,%r8	  # call sys_xxxx
+	BPON
 	st	%r2,SP_R2(%r15)   # store return value (change R2 on stack)
 
 sysc_return:
@@ -375,7 +405,9 @@
 	lm	%r3,%r6,SP_R3(%r15)
 	mvc	SP_ARGS(4,%r15),SP_R7(%r15)
 	l	%r2,SP_ORIG_R2(%r15)
+	BPOFF
 	basr	%r14,%r8		# call sys_xxx
+	BPON
 	st	%r2,SP_R2(%r15)		# store return value
 sysc_tracenogo:
 	tm	__TI_flags+2(%r12),_TIF_SYSCALL
--- a/arch/s390/kernel/vmlinux.lds.S
+++ b/arch/s390/kernel/vmlinux.lds.S
@@ -86,6 +86,9 @@
 		__alt_instructions = .;
 		*(.altinstructions)
 		__alt_instructions_end = .;
+		__alt_nobp = .;
+		*(.altnobp)
+		__alt_nobp_end = .;
 	}
 
 	/*
