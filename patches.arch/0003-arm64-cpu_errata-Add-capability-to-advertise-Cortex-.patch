From: Marc Zyngier <marc.zyngier@arm.com>
Date: Mon, 20 Mar 2017 17:18:06 +0000
Subject: arm64: cpu_errata: Add capability to advertise Cortex-A73 erratum
 858921
Git-commit: b0f0a6a803aada6268a546c3faf1987e36cbb3ca
Patch-mainline: Queued
Git-repo: git://git.kernel.org/pub/scm/linux/kernel/git/next/linux-next.git
References: fate#322150

In order to work around Cortex-A73 erratum 858921 in a subsequent
patch, add the required capability that advertise the erratum.

As the configuration option it depends on is not present yet,
this has no immediate effect.

Signed-off-by: Marc Zyngier <marc.zyngier@arm.com>
[mb: add define to cpufeatures.h instead of cpucaps.h]
Signed-off-by: Matthias Brugger <mbrugger@suse.com>
---
 Documentation/arm64/silicon-errata.txt |    1 +
 arch/arm64/include/asm/cpufeature.h    |    3 ++-
 arch/arm64/kernel/cpu_errata.c         |    8 ++++++++
 3 files changed, 11 insertions(+), 1 deletion(-)

--- a/Documentation/arm64/silicon-errata.txt
+++ b/Documentation/arm64/silicon-errata.txt
@@ -54,6 +54,7 @@ stable kernels.
 | ARM            | Cortex-A57      | #852523         | N/A                     |
 | ARM            | Cortex-A57      | #834220         | ARM64_ERRATUM_834220    |
 | ARM            | Cortex-A72      | #853709         | N/A                     |
+| ARM            | Cortex-A73      | #858921         | ARM64_ERRATUM_858921    |
 | ARM            | MMU-500         | #841119,#826419 | N/A                     |
 |                |                 |                 |                         |
 | Cavium         | ThunderX ITS    | #22375, #24313  | CAVIUM_ERRATUM_22375    |
--- a/arch/arm64/include/asm/cpufeature.h
+++ b/arch/arm64/include/asm/cpufeature.h
@@ -39,8 +39,9 @@
 #define ARM64_HAS_VIRT_HOST_EXTN		14
 #define ARM64_HYP_OFFSET_LOW			15
 #define ARM64_WORKAROUND_REPEAT_TLBI		16
+#define ARM64_WORKAROUND_858921			17
 
-#define ARM64_NCAPS				17
+#define ARM64_NCAPS				18
 
 #ifndef __ASSEMBLY__
 
--- a/arch/arm64/kernel/cpu_errata.c
+++ b/arch/arm64/kernel/cpu_errata.c
@@ -130,6 +130,14 @@ const struct arm64_cpu_capabilities arm6
 			   MIDR_CPU_VAR_REV(0, 0)),
 	},
 #endif
+#ifdef CONFIG_ARM64_ERRATUM_858921
+	{
+	/* Cortex-A73 all versions */
+		.desc = "ARM erratum 858921",
+		.capability = ARM64_WORKAROUND_858921,
+		MIDR_ALL_VERSIONS(MIDR_CORTEX_A73),
+	},
+#endif
 	{
 	}
 };
