From: Martin Schwidefsky <schwidefsky@de.ibm.com>
Subject: s390: add ppa to the idle loop
Patch-mainline: no, SLES 11 only
References: bnc#1077406, LTC#163910

s390: add ppa to the idle loop

Signed-off-by: Hendrik Brueckner <brueckner@linux.vnet.ibm.com>
Signed-off-by: Martin Schwidefsky <schwidefsky@de.ibm.com>
Acked-by: Johannes Thumshirn <jthumshirn@suse.de>
---
 arch/s390/Makefile           |    2 ++
 arch/s390/include/asm/nobp.h |   21 +++++++++++++++++++++
 arch/s390/kernel/vtime.c     |    4 ++++
 3 files changed, 27 insertions(+)

--- a/arch/s390/Makefile
+++ b/arch/s390/Makefile
@@ -42,6 +42,8 @@ cflags-$(CONFIG_MARCH_Z9_109) += $(call
 cflags-$(CONFIG_MARCH_Z10) += $(call cc-option,-march=z10)
 cflags-$(CONFIG_MARCH_Z196) += $(call cc-option,-march=z196)
 
+cflags-y += -Wa,-I$(srctree)/arch/$(ARCH)/include
+
 #KBUILD_IMAGE is necessary for make rpm
 KBUILD_IMAGE	:=arch/s390/boot/image
 
--- /dev/null
+++ b/arch/s390/include/asm/nobp.h
@@ -0,0 +1,21 @@
+#ifndef __ASM_S390_NOBP_H
+#define __ASM_S390_NOBP_H
+
+#ifdef __ASSEMBLY__
+
+.macro BPON
+	.pushsection .altinstr_replacement, "ax"
+662:	.long	0xb2e8d000
+	.popsection
+663:	.long	0x47000000
+	.pushsection .altnobp, "a"
+        .long 663b - .
+	.long 662b - .
+	.word 82
+	.byte 4
+	.byte 4
+	.popsection
+.endm
+
+#endif	/* __ASSEMBLY__ */
+#endif	/* __ASM_S390_NOBP_H */
--- a/arch/s390/kernel/vtime.c
+++ b/arch/s390/kernel/vtime.c
@@ -27,6 +27,8 @@
 #include <asm/cputime.h>
 #include <asm/irq.h>
 
+asm(".include \"asm/nobp.h\"\n");
+
 static DEFINE_PER_CPU(struct vtimer_queue, virt_cpu_timer);
 
 DEFINE_PER_CPU(struct s390_idle_data, s390_idle);
@@ -203,6 +205,7 @@ void __kprobes vtime_stop_cpu(void)
 			"	larl	1,1f\n"
 			"	stg	1,8(%2)\n"
 #endif /* CONFIG_64BIT */
+			"	BPON	     \n"
 			"	stpt	0(%4)\n"
 			"	spt	0(%5)\n"
 			"	stck	0(%3)\n"
@@ -236,6 +239,7 @@ void __kprobes vtime_stop_cpu(void)
 			"	larl	1,1f\n"
 			"	stg	1,8(%2)\n"
 #endif /* CONFIG_64BIT */
+			"	BPON	     \n"
 			"	stpt	0(%4)\n"
 			"	stck	0(%3)\n"
 #ifndef CONFIG_64BIT
