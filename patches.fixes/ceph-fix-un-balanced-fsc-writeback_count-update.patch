From: "Yan, Zheng" <zyan@redhat.com>
Date: Fri, 15 Dec 2017 16:57:40 +0800
Subject: ceph: fix un-balanced fsc->writeback_count update
Git-commit: 314c4737a45dd4447eac6d313e3715b25785f58b
Patch-mainline: v4.16-rc1
References: bsc#1081735

Signed-off-by: "Yan, Zheng" <zyan@redhat.com>
Signed-off-by: Ilya Dryomov <idryomov@gmail.com>
[luis: adjusted context]
Acked-by: Luis Henriques <lhenriques@suse.com>
---
 fs/ceph/addr.c |    9 ++++++---
 1 file changed, 6 insertions(+), 3 deletions(-)

--- a/fs/ceph/addr.c
+++ b/fs/ceph/addr.c
@@ -525,7 +525,6 @@ static int writepage_nounlock(struct pag
 	struct ceph_snap_context *snapc, *oldest;
 	loff_t page_off = page_offset(page);
 	loff_t snap_size = -1;
-	long writeback_stat;
 	u64 truncate_size;
 	u32 truncate_seq;
 	int err, len = PAGE_CACHE_SIZE;
@@ -571,8 +570,7 @@ static int writepage_nounlock(struct pag
 	dout("writepage %p page %p index %lu on %llu~%u snapc %p\n",
 	     inode, page, page->index, page_off, len, snapc);
 
-	writeback_stat = atomic_long_inc_return(&fsc->writeback_count);
-	if (writeback_stat >
+	if (atomic_long_inc_return(&fsc->writeback_count) >
 	    CONGESTION_ON_THRESH(fsc->mount_options->congestion_kb))
 		set_bdi_congested(&fsc->backing_dev_info, BLK_RW_ASYNC);
 
@@ -607,6 +605,11 @@ static int writepage_nounlock(struct pag
 	end_page_writeback(page);
 	ceph_put_wrbuffer_cap_refs(ci, 1, snapc);
 	ceph_put_snap_context(snapc);  /* page's reference */
+
+	if (atomic_long_dec_return(&fsc->writeback_count) <
+	    CONGESTION_OFF_THRESH(fsc->mount_options->congestion_kb))
+		clear_bdi_congested(inode_to_bdi(inode), BLK_RW_ASYNC);
+
 	return err;
 }
 
