From: David Howells <dhowells@redhat.com>
Date: Mon, 19 Oct 2015 11:20:28 +0100
Subject: [PATCH 2/3] KEYS: Don't permit request_key() to construct a new
 keyring

Git-commit: 911b79cde95c7da0ec02f48105358a36636b7a71
Patch-mainline: v4.4 or v4.3-rc7 (next release)
References: CVE-2015-7872 bsc#951440

If request_key() is used to find a keyring, only do the search part -
don't
do the construction part if the keyring was not found by the search.  We
don't really want keyrings in the negative instantiated state since the
rejected/negative instantiation error value in the payload is unioned
with
keyring metadata.

Now the kernel gives an error:

	request_key("keyring", "#selinux,bdekeyring", "keyring",
KEY_SPEC_USER_SESSION_KEYRING) = -1 EPERM (Operation not permitted)

Signed-off-by: David Howells <dhowells@redhat.com>
Acked-by: Lee, Chun-Yi <jlee@suse.com>
---
 security/keys/request_key.c | 3 +++
 1 file changed, 3 insertions(+)

diff --git a/security/keys/request_key.c b/security/keys/request_key.c
index 8246532..1390b63 100644
--- a/security/keys/request_key.c
+++ b/security/keys/request_key.c
@@ -449,6 +449,9 @@ static struct key *construct_key_and_link(struct key_type *type,
 
 	kenter("");
 
+	if (type == &key_type_keyring)
+		return ERR_PTR(-EPERM);
+
 	user = key_user_lookup(current_fsuid(), current_user_ns());
 	if (!user)
 		return ERR_PTR(-ENOMEM);
-- 
1.8.4.5

