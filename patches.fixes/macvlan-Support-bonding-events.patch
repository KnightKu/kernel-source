From 3782e998375d0ae6e750ab824b1cf0284031fc01 Mon Sep 17 00:00:00 2001
From: Vlad Yasevich <vyasevic@redhat.com>
Date: Wed, 4 Jun 2014 16:23:37 -0400
Subject: [PATCH] macvlan: Support bonding events
Patch-mainline: 3.16-rc1
References: bsc#948521
Git-commit: 4c9912556867bf89e7bb6946fd218a40b1d12139

Bonding and team drivers generate specific events during failover
that trigger switch updates.  When a macvlan device is configured
on top of bonding, we want switches to learn about the macvlan
devices as well.   This patch adds a handler to macvlan driver to
propagate these events to all macvlan devices.  We let the generic
inetdev event handler do the work.

This allows macvlan to operated correctly over active-backup
mode bond.

Signed-off-by: Vlad Yasevich <vyasevic@redhat.com>
Signed-off-by: David S. Miller <davem@davemloft.net>
Acked-by: Michal Kubecek <mkubecek@suse.cz>
Acked-by: Ales Novak <alnovak@suse.cz>
---
 drivers/net/macvlan.c | 6 ++++++
 1 file changed, 6 insertions(+)

diff --git a/drivers/net/macvlan.c b/drivers/net/macvlan.c
index 21d8446..9f362cf 100644
--- a/drivers/net/macvlan.c
+++ b/drivers/net/macvlan.c
@@ -812,6 +812,12 @@ static int macvlan_device_event(struct notifier_block *unused,
 	case NETDEV_PRE_TYPE_CHANGE:
 		/* Forbid underlaying device to change its type. */
 		return NOTIFY_BAD;
+
+	case NETDEV_NOTIFY_PEERS:
+	case NETDEV_BONDING_FAILOVER:
+		/* Propagate to all vlans */
+		list_for_each_entry(vlan, &port->vlans, list)
+			call_netdevice_notifiers(event, vlan->dev);
 	}
 	return NOTIFY_DONE;
 }
-- 
2.4.1.168.g1ea28e1

