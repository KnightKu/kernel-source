From 328b1a077c5f33cf9dffc98ed805a36eea08d7dc Mon Sep 17 00:00:00 2001
From: Jeff Mahoney <jeffm@suse.com>
Date: Tue, 7 Jun 2016 15:11:53 -0400
Subject: [PATCH] ecryptfs: don't allow mmap when the lower file system doesn't allow it
References: bsc#983143 CVE-2016-1583
Patch-mainline: Not yet, see bugzilla

There are legitimate reasons to disallow mmap on certain files, notably
in sysfs or procfs.  We shouldn't emulate mmap support on file systems
that don't offer support natively.

Signed-off-by: Jeff Mahoney <jeffm@suse.com>
---
 fs/ecryptfs/file.c |    4 ++++
 1 file changed, 4 insertions(+)

--- a/fs/ecryptfs/file.c
+++ b/fs/ecryptfs/file.c
@@ -152,6 +152,10 @@ static const struct vm_operations_struct
 static int ecryptfs_file_mmap(struct file *file, struct vm_area_struct *vma)
 {
 	int rc;
+	struct dentry *dentry = ecryptfs_dentry_to_lower(file->f_dentry);
+
+	if (!dentry->d_inode->i_fop->mmap)
+		return -ENODEV;
 
 	rc = generic_file_mmap(file, vma);
 	if (!rc)
