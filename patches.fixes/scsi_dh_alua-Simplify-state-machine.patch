From: Hannes Reinecke <hare@suse.de>
Date: Fri, 28 Feb 2014 10:20:58 +0100
Subject: scsi_dh_alua: Simplify state machine
References: bnc#854025
Patch-Mainline: Not yet

ALUA_PG_STPG_DONE is not required, so just drop it and simplify
the state machine.

Signed-off-by: Hannes Reinecke <hare@suse.de>
---
 drivers/scsi/device_handler/scsi_dh_alua.c | 20 +++-----------------
 1 file changed, 3 insertions(+), 17 deletions(-)

diff --git a/drivers/scsi/device_handler/scsi_dh_alua.c b/drivers/scsi/device_handler/scsi_dh_alua.c
index 017d0ee..87f1986 100644
--- a/drivers/scsi/device_handler/scsi_dh_alua.c
+++ b/drivers/scsi/device_handler/scsi_dh_alua.c
@@ -67,7 +67,6 @@
 /* State machine flags */
 #define ALUA_PG_RUN_RTPG		0x10
 #define ALUA_PG_RUN_STPG		0x20
-#define ALUA_PG_STPG_DONE		0x40
 
 
 static LIST_HEAD(port_group_list);
@@ -965,7 +964,6 @@ static void alua_rtpg_work(struct work_struct *work)
 		err = alua_stpg(sdev, pg);
 		spin_lock_irqsave(&pg->rtpg_lock, flags);
 		pg->flags &= ~ALUA_PG_RUN_STPG;
-		pg->flags |= ALUA_PG_STPG_DONE;
 		if (err == SCSI_DH_RETRY) {
 			pg->flags |= ALUA_PG_RUN_RTPG;
 			pg->interval = ALUA_RTPG_DELAY_MSECS * 1000;
@@ -1002,29 +1000,17 @@ static void alua_rtpg_queue(struct alua_port_group *pg,
 
 	kref_get(&pg->kref);
 	spin_lock_irqsave(&pg->rtpg_lock, flags);
-	if (qdata)
+	if (qdata) {
 		list_add_tail(&qdata->entry, &pg->rtpg_list);
+		pg->flags |= ALUA_PG_RUN_STPG;
+	}
 	if (pg->rtpg_sdev == NULL) {
 		pg->interval = 0;
-		pg->flags &= ~ALUA_PG_STPG_DONE;
 		pg->flags |= ALUA_PG_RUN_RTPG;
-		if (qdata)
-			pg->flags |= ALUA_PG_RUN_STPG;
-
 		kref_get(&pg->kref);
 		pg->rtpg_sdev = sdev;
 		scsi_device_get(sdev);
 		start_queue = 1;
-	} else {
-		/*
-		 * RTPG update is already queued.
-		 * Check if STPG is scheduled or done,
-		 * and set the STPG flag if not.
-		 */
-		if (qdata &&
-		    !(pg->flags & ALUA_PG_RUN_STPG) &&
-		    !(pg->flags & ALUA_PG_STPG_DONE))
-			pg->flags |= ALUA_PG_RUN_STPG;
 	}
 	spin_unlock_irqrestore(&pg->rtpg_lock, flags);
 
-- 
1.7.12.4

