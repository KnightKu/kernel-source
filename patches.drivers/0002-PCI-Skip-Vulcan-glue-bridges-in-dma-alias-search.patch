From 1bdaf92add63d4cb9ef098989d0d908c3ff3a050 Mon Sep 17 00:00:00 2001
From: Jayachandran C <c.jayachandran@gmail.com>
Date: Fri, 16 Dec 2016 16:54:50 +0530
Subject: [PATCH 2/2] PCI: Skip Vulcan glue bridges in dma alias search

Patch-Mainline: Never, Workaround essential for boot.
References: fate#322326

On Broadcom Vulcan, there are 'glue' PCI bridges above the real
PCIe root complex which is connected to the SMMU and GIC. Going
above the real root complex in alias search will give incorrect
RIDs which in turn will confuse the SMMU and GIC.

Workaround the issue by returning if we see the glue bridges
during dma alias search.

Signed-off-by: Robert Richter <rrichter@cavium.com>
Signed-off-by: Mian Yousaf Kaukab <yousaf.kaukab@suse.com>
---
 drivers/pci/search.c | 9 +++++++++
 1 file changed, 9 insertions(+)

diff --git a/drivers/pci/search.c b/drivers/pci/search.c
index 33e0f033a48e..bc43990a5ea1 100644
--- a/drivers/pci/search.c
+++ b/drivers/pci/search.c
@@ -61,6 +61,15 @@ int pci_for_each_dma_alias(struct pci_dev *pdev,
 		tmp = bus->self;
 
 		/*
+		 * Stop at bridges where IOMMU is attached, going
+		 * further up finds invalid aliases.
+		 */
+		if (IS_ENABLED(CONFIG_ARM64) &&
+		    tmp->vendor == PCI_VENDOR_ID_BROADCOM &&
+		    (tmp->device == 0x9000 || tmp->device == 0x9084))
+			return ret;
+
+		/*
 		 * PCIe-to-PCI/X bridges alias transactions from downstream
 		 * devices using the subordinate bus number (PCI Express to
 		 * PCI/PCI-X Bridge Spec, rev 1.0, sec 2.3).  For all cases
-- 
2.11.0

