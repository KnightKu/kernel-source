From b56d1003512c33aa1752d84e3fa078bc76b15bf8 Mon Sep 17 00:00:00 2001
From: Eric Northup <digitaleric@google.com>
Date: Thu, 8 Nov 2012 01:55:50 -0800
Subject: [PATCH] [SCSI] virtio_scsi: fix memory leak on full queue condition.
git-commit: b56d1003512c33aa1752d84e3fa078bc76b15bf8
Patch-mainline: v3.10
References: bsc#1028880

virtscsi_queuecommand was leaking memory when the virtio queue was full.

Tested: Guest operates correctly even with very small queue sizes, validated
we're not leaking kmalloc-192 sized allocations anymore.

Signed-off-by: Eric Northup <digitaleric@google.com>
Acked-by: Paolo Bonzini <pbonzini@redhat.com>
Signed-off-by: James Bottomley <JBottomley@Parallels.com>
Acked-by: Thomas Abraham <tabraham@suse.com>
---
 drivers/scsi/virtio_scsi.c | 2 ++
 1 file changed, 2 insertions(+)

diff --git a/drivers/scsi/virtio_scsi.c b/drivers/scsi/virtio_scsi.c
index 595af1a..dd8dc27 100644
--- a/drivers/scsi/virtio_scsi.c
+++ b/drivers/scsi/virtio_scsi.c
@@ -469,6 +469,8 @@ static int virtscsi_queuecommand(struct Scsi_Host *sh, struct scsi_cmnd *sc)
 			      sizeof cmd->req.cmd, sizeof cmd->resp.cmd,
 			      GFP_ATOMIC) >= 0)
 		ret = 0;
+	else
+		mempool_free(cmd, virtscsi_cmd_pool);
 
 out:
 	return ret;
-- 
2.10.2

