From: Alexey Obitotskiy <aleksey.obitotskiy@intel.com>
Date: Thu, 23 Jun 2016 12:11:01 +0200
Subject: Fix kernel module refcount handling
References: bsc#1003941,FATE#321732
Git-commit: 4cb9da7d9c631514effa5e806f9de7c7c746c3a8
Patch-Mainline: v4.8-rc1

md loads raidX modules and increments module refcount each time level
has changed but does not decrement it. You are unable to unload raid0
module after reshape because raid0 reshape changes level to raid4
and back to raid0.

Signed-off-by: Aleksey Obitotskiy <aleksey.obitotskiy@intel.com>
Signed-off-by: Shaohua Li <shli@fb.com>
Signed-off-by: Hannes Reinecke <hare@suse.de>
---
 drivers/md/md.c | 2 ++
 1 file changed, 2 insertions(+)

diff --git a/drivers/md/md.c b/drivers/md/md.c
index 7f6f282..20ff8d6 100644
--- a/drivers/md/md.c
+++ b/drivers/md/md.c
@@ -3585,6 +3585,8 @@ level_store(struct mddev *mddev, const char *buf, size_t len)
 			mddev->to_remove = &md_redundancy_group;
 	}
 
+	module_put(oldpers->owner);
+
 	rdev_for_each(rdev, mddev) {
 		if (rdev->raid_disk < 0)
 			continue;
-- 
1.8.5.6

