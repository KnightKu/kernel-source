From: Jens Axboe <axboe@fb.com>
Date: Mon, 1 Aug 2016 09:38:44 -0600
Subject: mm: make __swap_writepage() use bio_set_op_attrs()
References: bnc#1023798,FATE#321463
Patch-Mainline: v4.8-rc1
Git-commit: ba13e83ec334ca8a1c6bec882a6efc98d8bf355d

Cleaner than manipulating bio->bi_rw flags directly.

Signed-off-by: Jens Axboe <axboe@fb.com>
Acked-by: Hannes Reinecke <hare@suse.de>
---
 mm/page_io.c | 5 +++--
 1 file changed, 3 insertions(+), 2 deletions(-)

diff --git a/mm/page_io.c b/mm/page_io.c
index f3356a4..38bfff76 100644
--- a/mm/page_io.c
+++ b/mm/page_io.c
@@ -311,9 +311,10 @@ int __swap_writepage(struct page *page, struct writeback_control *wbc,
 		ret = -ENOMEM;
 		goto out;
 	}
-	bio_set_op_attrs(bio, REQ_OP_WRITE, 0);
 	if (wbc->sync_mode == WB_SYNC_ALL)
-		bio->bi_rw |= REQ_SYNC;
+		bio_set_op_attrs(bio, REQ_OP_WRITE, REQ_SYNC);
+	else
+		bio_set_op_attrs(bio, REQ_OP_WRITE, 0);
 	count_vm_event(PSWPOUT);
 	set_page_writeback(page);
 	unlock_page(page);
-- 
1.8.5.6

