From: James Smart <jsmart2021@gmail.com>
Date: Wed, 21 Jun 2017 10:51:23 -0700
Subject: lpfc: fix refcount error on node list
References: bsc#1045404
Patch-mainline: Submitted, http://www.spinics.net/lists/linux-scsi/msg110036.html

A change in remote port removal introduced a spurious put which
can cause a premature structure teardown. The affects were most
notable when the driver attempted to unload as a null pointer
would be hit.

Fix by removing the unnecessary put.

Signed-off-by: James Smart <james.smart@broadcom.com>
Signed-off-by: Johannes Thumshirn <jthumshirn@suse.de>
---
 drivers/scsi/lpfc/lpfc_init.c | 7 -------
 1 file changed, 7 deletions(-)

diff --git a/drivers/scsi/lpfc/lpfc_init.c b/drivers/scsi/lpfc/lpfc_init.c
index f4bc27590748..fe0dbcc32909 100644
--- a/drivers/scsi/lpfc/lpfc_init.c
+++ b/drivers/scsi/lpfc/lpfc_init.c
@@ -2803,13 +2803,6 @@ lpfc_cleanup(struct lpfc_vport *vport)
 			lpfc_disc_state_machine(vport, ndlp, NULL,
 					NLP_EVT_DEVICE_RECOVERY);
 
-		if (ndlp->nlp_fc4_type & NLP_FC4_NVME) {
-			/* Remove the NVME transport reference now and
-			 * continue to remove the node.
-			 */
-			lpfc_nlp_put(ndlp);
-		}
-
 		lpfc_disc_state_machine(vport, ndlp, NULL,
 					     NLP_EVT_DEVICE_RM);
 	}
-- 
2.12.3

