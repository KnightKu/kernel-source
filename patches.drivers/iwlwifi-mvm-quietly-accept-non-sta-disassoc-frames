From 51da3d8b94485a8397ae7af3bfdb65feaf582202 Mon Sep 17 00:00:00 2001
From: Johannes Berg <johannes.berg@intel.com>
Date: Mon, 12 Jun 2017 11:24:06 +0200
Subject: [PATCH] iwlwifi: mvm: quietly accept non-sta disassoc frames
Git-commit: 51da3d8b94485a8397ae7af3bfdb65feaf582202
Patch-mainline: 4.13-rc1
References: bsc#1051510

When a station that's not associated sends a data frame (e.g. an NDP)
hostapd will respond with a disassoc frame, telling it that it's not
associated. The station might also not be authenticated, in which case
there will not be a station entry for it, and as a result we need to
accept such frames without a station.

Fixes: 3ee0f0e23e4f ("iwlwifi: mvm: fix DQA AP mode station assumption")
Signed-off-by: Johannes Berg <johannes.berg@intel.com>
Signed-off-by: Luca Coelho <luciano.coelho@intel.com>
Acked-by: Takashi Iwai <tiwai@suse.de>

---
 drivers/net/wireless/intel/iwlwifi/mvm/tx.c |    3 ++-
 1 file changed, 2 insertions(+), 1 deletion(-)

--- a/drivers/net/wireless/intel/iwlwifi/mvm/tx.c
+++ b/drivers/net/wireless/intel/iwlwifi/mvm/tx.c
@@ -569,7 +569,8 @@ static int iwl_mvm_get_ctrl_vif_queue(st
 		 */
 		if (ieee80211_is_mgmt(fc) &&
 		    (!ieee80211_is_bufferable_mmpdu(fc) ||
-		    ieee80211_is_deauth(fc) || ieee80211_is_disassoc(fc)))
+		    ieee80211_is_deauth(fc) ||
+		    ieee80211_is_disassoc(fc)))
 			return mvm->probe_queue;
 		if (info->hw_queue == info->control.vif->cab_queue)
 			return mvmvif->cab_queue;
