From: Joerg Roedel <jroedel@suse.de>
Date: Mon, 21 Dec 2015 13:14:52 +0100
Subject: iommu/amd: Flush IOMMU TLB on __map_single error path
Git-commit: 53b3b65aa5befe9e96e8f8708a76208190a07e14
Patch-mainline: v4.5-rc1
References: fate#321026

There have been present PTEs which in theory could have made
it to the IOMMU TLB. Flush the addresses out on the error
path to make sure no stale entries remain.

Signed-off-by: Joerg Roedel <jroedel@suse.de>
---
 drivers/iommu/amd_iommu.c | 2 ++
 1 file changed, 2 insertions(+)

--- a/drivers/iommu/amd_iommu.c
+++ b/drivers/iommu/amd_iommu.c
@@ -2677,6 +2677,8 @@ out_unmap:
 		dma_ops_domain_unmap(dma_dom, start);
 	}
 
+	domain_flush_pages(&dma_dom->domain, address, size);
+
 	dma_ops_free_addresses(dma_dom, address, pages);
 
 	return DMA_ERROR_CODE;
