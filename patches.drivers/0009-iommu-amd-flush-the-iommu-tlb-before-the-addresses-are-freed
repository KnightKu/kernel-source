From: Joerg Roedel <jroedel@suse.de>
Date: Mon, 21 Dec 2015 13:23:59 +0100
Subject: iommu/amd: Flush the IOMMU TLB before the addresses are freed
Git-commit: 84b3a0bc88534d9e49d1642957f64db61a3aa5c4
Patch-mainline: v4.5-rc1
References: fate#321026

This allows to keep the bitmap_lock only for a very short
period of time.

Signed-off-by: Joerg Roedel <jroedel@suse.de>
---
 drivers/iommu/amd_iommu.c | 8 ++++----
 1 file changed, 4 insertions(+), 4 deletions(-)

--- a/drivers/iommu/amd_iommu.c
+++ b/drivers/iommu/amd_iommu.c
@@ -2711,14 +2711,14 @@ static void __unmap_single(struct dma_op
 		start += PAGE_SIZE;
 	}
 
-	SUB_STATS_COUNTER(alloced_io_mem, size);
-
-	dma_ops_free_addresses(dma_dom, dma_addr, pages);
-
 	if (amd_iommu_unmap_flush || dma_dom->need_flush) {
 		domain_flush_pages(&dma_dom->domain, flush_addr, size);
 		dma_dom->need_flush = false;
 	}
+
+	SUB_STATS_COUNTER(alloced_io_mem, size);
+
+	dma_ops_free_addresses(dma_dom, dma_addr, pages);
 }
 
 /*
