From e05b51bbf13feba57f16da06d0672e9461775b22 Mon Sep 17 00:00:00 2001
From: Hannes Reinecke <hare@suse.de>
Date: Thu, 13 Oct 2016 15:10:59 +0200
Subject: scsi: fcoe: correct sending FIP VLAN packets on VLAN 0
Git-commit: f7e6ed0654128979a1939be6640416abb6a54811
Patch-mainline: v4.10-rc1
Git-commit: e05b51bbf13feba57f16da06d0672e9461775b22
References: bsc#1023764

The FIP VLAN frame consists of an ethernet header followed
by the FIP VLAN frame, so we need to skip the ethernet header
if we want to check the FIP opcode.

Signed-off-by: Hannes Reinecke <hare@suse.com>
Reviewed-by: Bart Van Assche <bart.vanassche@sandisk.com>
Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
Signed-off-by: Johannes Thumshirn <jthumshirn@suse.de>

---
 drivers/scsi/fcoe/fcoe.c | 24 +++++++++++++++---------
 1 file changed, 15 insertions(+), 9 deletions(-)

diff --git a/drivers/scsi/fcoe/fcoe.c b/drivers/scsi/fcoe/fcoe.c
index 37dcd2a..9bfc647 100644
--- a/drivers/scsi/fcoe/fcoe.c
+++ b/drivers/scsi/fcoe/fcoe.c
@@ -601,16 +601,22 @@ static void fcoe_port_send(struct fcoe_port *port, struct sk_buff *skb)
  */
 static void fcoe_fip_send(struct fcoe_ctlr *fip, struct sk_buff *skb)
 {
-	struct ethhdr *eh = eth_hdr(skb);
-	struct fip_header *fiph = NULL;
+	struct fcoe_interface *fcoe = fcoe_from_ctlr(fip);
+	struct fip_frame {
+		struct ethhdr eth;
+		struct fip_header fip;
+	} __packed *frame;
 
-	skb->dev = fcoe_from_ctlr(fip)->netdev;
-	if (ntohs(eh->h_proto) == ETH_P_FIP) {
-		fiph = (struct fip_header *)((unsigned char *)eh +
-					     sizeof(struct ethhdr));
-		if (ntohs(fiph->fip_op) == FIP_OP_VLAN)
-			skb->dev = fcoe_from_ctlr(fip)->realdev;
-	}
+	/*
+	 * Use default VLAN for FIP VLAN discovery protocol
+	 */
+	frame = (struct fip_frame *)skb->data;
+	if (ntohs(frame->eth.h_proto) == ETH_P_FIP &&
+	    ntohs(frame->fip.fip_op) == FIP_OP_VLAN &&
+	    fcoe->realdev != fcoe->netdev)
+		skb->dev = fcoe->realdev;
+	else
+		skb->dev = fcoe->netdev;
 	fcoe_port_send(lport_priv(fip->lp), skb);
 }
 
-- 
1.8.5.6

