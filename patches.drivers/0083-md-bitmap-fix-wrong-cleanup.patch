From: Shaohua Li <shli@fb.com>
Date: Tue, 13 Sep 2016 10:28:00 -0700
Subject: md/bitmap: fix wrong cleanup
References: bsc#1003941,FATE#321732
Git-commit: f71f1cf97c781db1be8ae0190e0983e1fceac14a
Patch-Mainline: v4.9-rc1

if bitmap_create fails, the bitmap is already cleaned up and the returned value
is an error number. We can't do the cleanup again.

Reported-by: Christophe JAILLET <christophe.jaillet@wanadoo.fr>
Signed-off-by: Shaohua Li <shli@fb.com>
Signed-off-by: Hannes Reinecke <hare@suse.de>
---
 drivers/md/bitmap.c | 4 +---
 1 file changed, 1 insertion(+), 3 deletions(-)

diff --git a/drivers/md/bitmap.c b/drivers/md/bitmap.c
index fae132e..09a6310 100644
--- a/drivers/md/bitmap.c
+++ b/drivers/md/bitmap.c
@@ -1930,10 +1930,8 @@ int bitmap_copy_from_slot(struct mddev *mddev, int slot,
 	struct bitmap_counts *counts;
 	struct bitmap *bitmap = bitmap_create(mddev, slot);
 
-	if (IS_ERR(bitmap)) {
-		bitmap_free(bitmap);
+	if (IS_ERR(bitmap))
 		return PTR_ERR(bitmap);
-	}
 
 	rv = bitmap_init_from_disk(bitmap, 0);
 	if (rv)
-- 
1.8.5.6

