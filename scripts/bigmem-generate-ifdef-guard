#!/bin/sh

# Auto-Generate a guard patch that #ifdef's the changes made by the
# patches.arch/ppc64-bigmem-* series.

# cd kernel_source
# ./scripts/bigmem-generate-ifdef-guard
# vi bigmem-all-CONFIG
#	# [ "__rpte_sub_valid(rpte, index)) do { \" <- remove that space+backslash!]
# # (The source code before this series is already broken in that respect.)
# # if satisfied,
# mv bigmem-all-CONFIG patches.suse/ppc64-bigmem-introduce-CONFIG_BIGMEM 

# echo $SCRATCH_AREA
kernel_version=3.0-SLE11-SP4
suse_git=$PWD
ISO_date=`date +%F`

./scripts/sequence-patch.sh --fast patches.arch/ppc64-bigmem-01-*
cd $SCRATCH_AREA
rm -rf c
mkdir -p c/arch
cp -pr linux-$kernel_version/arch/powerpc c/arch/.
cat linux-$kernel_version/patches/patches.arch/ppc64-bigmem-* | patch -d linux-$kernel_version -s -p1
ln -sfn linux-$kernel_version b
ln -sfn c a
diff -durp {a,b}/arch/powerpc > $suse_git/bigmem-all
patch -d c -p1 -D CONFIG_BIGMEM < $suse_git/bigmem-all
ln -sfn c b
ln -sfn linux-$kernel_version a

/bin/echo -e "From: Torsten Duwe <duwe@suse.de>\nSubject: Make bigmem patches configurable" > $suse_git/bigmem-all-CONFIG
/bin/echo -e "Patch-mainline: never, only makes feature update switch OBS compliant\nReferences: bsc#928138,fate#319026\n\n" >> $suse_git/bigmem-all-CONFIG

/bin/echo -e "Acked-by: Torsten Duwe <duwe@suse.de>\n\n" >> $suse_git/bigmem-all-CONFIG

diff -urp {a,b}/arch/powerpc | \
    perl -p -e "m,^(\+\+\+ b|--- a)/, && s,\s*$ISO_date.*,,;" \
    >> $suse_git/bigmem-all-CONFIG
