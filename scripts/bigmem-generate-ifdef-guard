#!/bin/sh

# Auto-Generate a guard patch that #ifdef's the changes made by the
# patches.arch/ppc64-bigmem-* series.

. $(dirname $0)/../rpm/config.sh
. $(dirname "$0")/wd-functions.sh

TAG=$(get_branch_name)
TAG=${TAG//\//_}
kernel_version=$SRCVERSION
[ -n "$TAG" ] && kernel_version=$kernel_version-$TAG
suse_git=$PWD
target_patch=patches.suse/ppc64-bigmem-introduce-CONFIG_BIGMEM
ISO_date=`date +%F`


if [ -z "$SCRATCH_AREA" ]; then
    echo "SCRATCH_AREA not defined (defaulting to \"tmp\")"
    SCRATCH_AREA=tmp
fi

./scripts/sequence-patch.sh --fast patches.arch/ppc64-bigmem-01-*
cd $SCRATCH_AREA
rm -rf c
mkdir -p c/arch
cp -pr linux-$kernel_version/arch/powerpc c/arch/.
cat linux-$kernel_version/patches/patches.arch/ppc64-bigmem-* | patch -d linux-$kernel_version -s -p1
ln -sfn linux-$kernel_version b
ln -sfn c a
diff -durp {a,b}/arch/powerpc > $suse_git/bigmem-all
patch -d c -p1 -D CONFIG_BIGMEM < $suse_git/bigmem-all
ln -sfn c b
ln -sfn linux-$kernel_version a

/bin/echo -e "From: Torsten Duwe <duwe@suse.de>\nSubject: Make bigmem patches configurable" > $suse_git/$target_patch
/bin/echo -e "Patch-mainline: never, only makes feature update switch OBS compliant\nReferences: bsc#928138,fate#319026\n" >> $suse_git/$target_patch

/bin/echo -e "*** Autogenerated by $0 -- DO NOT EDIT ! ***\n" >> $suse_git/$target_patch

diff -urp {a,b}/arch/powerpc | \
    perl -p -e "m,^(\+\+\+ b|--- a)/, && s,\s*$ISO_date.*,,;" \
    >> $suse_git/$target_patch

rm -f $suse_git/bigmem-all
