From 732acbe95601c0f7b1a4e1bbb1f3972ad4efde28 Mon Sep 17 00:00:00 2001
From: Dan Carpenter <dan.carpenter@oracle.com>
Date: Mon, 17 Jul 2017 11:13:35 +0300
Subject: [PATCH] libceph: potential NULL dereference in ceph_msg_data_create()
Git-commit: 7c40b22f6f84c98a1d36e6d0a4346e58f05e45d8
Patch-mainline: v4.13
References: bsc#1051515

If kmem_cache_zalloc() returns NULL then the INIT_LIST_HEAD(&data->links);
will Oops.  The callers aren't really prepared for NULL returns so it
doesn't make a lot of difference in real life.

Fixes: 5240d9f95dfe ("libceph: replace message data pointer with list")
Signed-off-by: Dan Carpenter <dan.carpenter@oracle.com>
Signed-off-by: Ilya Dryomov <idryomov@gmail.com>
Signed-off-by: Oliver Neukum <oneukum@suse.com>
---
 net/ceph/messenger.c | 6 ++++--
 1 file changed, 4 insertions(+), 2 deletions(-)

diff --git a/net/ceph/messenger.c b/net/ceph/messenger.c
index fde0dd24a7bf..b232db4446aa 100644
--- a/net/ceph/messenger.c
+++ b/net/ceph/messenger.c
@@ -3034,8 +3034,10 @@ static struct ceph_msg_data *ceph_msg_data_create(enum ceph_msg_data_type type)
 		return NULL;
 
 	data = kmem_cache_zalloc(ceph_msg_data_cache, GFP_NOFS);
-	if (data)
-		data->type = type;
+	if (!data)
+		return NULL;
+
+	data->type = type;
 	INIT_LIST_HEAD(&data->links);
 
 	return data;
-- 
2.12.3

