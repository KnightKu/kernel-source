From: Tim Chen <tim.c.chen@linux.intel.com>
Date: Sat, 16 Dec 2017 18:25:12 +0100
Subject: x86/mm: Set IBPB upon context switch
Patch-mainline: submitted on 2018/1/9
References: bsc#1068032

Set IBPB on context switch when writing CR3.

Signed-off-by: Tim Chen <tim.c.chen@linux.intel.com>
[ Convert to do x86_ibp_barrier(). ]
Signed-off-by: Borislav Petkov <bp@suse.de>
---
 arch/x86/mm/tlb.c |    3 +++
 1 file changed, 3 insertions(+)

--- a/arch/x86/mm/tlb.c
+++ b/arch/x86/mm/tlb.c
@@ -13,6 +13,7 @@
 #include <asm/apic.h>
 #include <asm/uv/uv.h>
 #include <asm/kaiser.h>
+#include <asm/spec_ctrl.h>
 
 DEFINE_PER_CPU_SHARED_ALIGNED(struct tlb_state, cpu_tlbstate)
 			= { &init_mm, 0, };
@@ -116,6 +117,8 @@ void switch_mm_irqs_off(struct mm_struct
 	unsigned cpu = smp_processor_id();
 
 	if (likely(prev != next)) {
+		x86_ibp_barrier();
+
 		percpu_write(cpu_tlbstate.state, TLBSTATE_OK);
 		percpu_write(cpu_tlbstate.active_mm, next);
 		cpumask_set_cpu(cpu, mm_cpumask(next));
