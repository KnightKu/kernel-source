From 3ff2791fd7ebe4d364ce74cd65dfa133fcc75e84 Mon Sep 17 00:00:00 2001
From: orthos <orthos@huawei5.arch.suse.de>
Date: Tue, 16 Jan 2018 14:29:39 +0100
Subject: [PATCH] arm64: Don't force KPTI for CPUs that are not vulnerable

Patch-mainline: Submitted, https://patchwork.kernel.org/patch/10149123/
References: bsc#1076187

Signed-off-by: Jayachandran C <jnair@caviumnetworks.com>
Signed-off-by: Mian Yousaf Kaukab <yousaf.kaukab@suse.com>
---
 arch/arm64/kernel/cpufeature.c | 7 +++++++
 1 file changed, 7 insertions(+)

diff --git a/arch/arm64/kernel/cpufeature.c b/arch/arm64/kernel/cpufeature.c
index 9e231ba9b88a..05c16896bda5 100644
--- a/arch/arm64/kernel/cpufeature.c
+++ b/arch/arm64/kernel/cpufeature.c
@@ -753,6 +753,13 @@ static bool unmap_kernel_at_el0(const struct arm64_cpu_capabilities *entry,
 	if (IS_ENABLED(CONFIG_RANDOMIZE_BASE))
 		return true;
 
+	/* Don't force KPTI for CPUs that are not vulnerable */
+	switch (read_cpuid_id() & MIDR_CPU_MODEL_MASK) {
+		case MIDR_CAVIUM_THUNDERX2:
+		case MIDR_BRCM_VULCAN:
+			return false;
+	}
+
 	/* Defer to CPU feature registers */
 	return !cpuid_feature_extract_unsigned_field(pfr0,
 						     ID_AA64PFR0_CSV3_SHIFT);
-- 
2.11.0

