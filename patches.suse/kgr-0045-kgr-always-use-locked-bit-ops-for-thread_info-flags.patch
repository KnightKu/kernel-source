From: Michal Hocko <mhocko@suse.cz>
Date: Wed, 12 Nov 2014 09:47:57 +0100
Subject: kgr: always use locked bit ops for thread_info->flags
Patch-mainline: submitted for review
References: fate#313296 bnc#904681

thread_info->flags are usually modified by {set,clear}_ti_thread_flag
resp. test_and_clear_ti_thread_flag helpers which make sure that the bit
operation is locked properly. This is mainly because flags might be
modified by other tasks as well (e.g. set_tsk_thread_flag). This means
that users that do not use the helper have to follow the same rules
otherwise the bit operation can cause RMW cycle race and overwrite the
outcome of the locked operation.

This was the case for bnc#904681 where the TIF_KGR_IN_PROGRESS flag clearing
done from the sysret, trace and int_careful arch specific asm path has
overwritten TIF_SIGPENDING set during group_exit and so a thread has missed to
process pending SIGKILL signal and ended up unkillable by SIGKILL.

Fixes: kgr: make a per-process 'in progress' flag a single bit
Signed-off-by: Michal Hocko <mhocko@suse.cz>
Signed-off-by: Jiri Kosina <jkosina@suse.cz>
Signed-off-by: Jiri Slaby <jslaby@suse.cz>
---
 arch/x86/kernel/entry_64.S | 6 +++---
 1 file changed, 3 insertions(+), 3 deletions(-)

diff --git a/arch/x86/kernel/entry_64.S b/arch/x86/kernel/entry_64.S
index 46767274c014..c8228e86def1 100644
--- a/arch/x86/kernel/entry_64.S
+++ b/arch/x86/kernel/entry_64.S
@@ -452,7 +452,7 @@ sysret_check:
 	/* edx:	work, edi: workmask */
 sysret_careful:
 #if IS_ENABLED(CONFIG_KGRAFT)
-	andl $~_TIF_KGR_IN_PROGRESS,TI_flags+THREAD_INFO(%rsp,RIP-ARGOFFSET)
+	LOCK_PREFIX ; andl $~_TIF_KGR_IN_PROGRESS,TI_flags+THREAD_INFO(%rsp,RIP-ARGOFFSET)
 #endif
 	bt $TIF_NEED_RESCHED,%edx
 	jnc sysret_signal
@@ -518,7 +518,7 @@ sysret_audit:
 	/* Do syscall tracing */
 tracesys:
 #if IS_ENABLED(CONFIG_KGRAFT)
-	andl $~_TIF_KGR_IN_PROGRESS,TI_flags+THREAD_INFO(%rsp,RIP-ARGOFFSET)
+	LOCK_PREFIX ; andl $~_TIF_KGR_IN_PROGRESS,TI_flags+THREAD_INFO(%rsp,RIP-ARGOFFSET)
 #endif
 #ifdef CONFIG_AUDITSYSCALL
 	testl $(_TIF_WORK_SYSCALL_ENTRY & ~_TIF_SYSCALL_AUDIT),TI_flags+THREAD_INFO(%rsp,RIP-ARGOFFSET)
@@ -571,7 +571,7 @@ GLOBAL(int_with_check)
 	/* edx:	work, edi: workmask */
 int_careful:
 #if IS_ENABLED(CONFIG_KGRAFT)
-	andl $~_TIF_KGR_IN_PROGRESS,TI_flags(%rcx)
+	LOCK_PREFIX ; andl $~_TIF_KGR_IN_PROGRESS,TI_flags(%rcx)
 #endif
 	bt $TIF_NEED_RESCHED,%edx
 	jnc  int_very_careful
-- 
2.1.3

