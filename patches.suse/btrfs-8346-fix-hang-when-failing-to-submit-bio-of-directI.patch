From: Liu Bo <bo.li.liu@oracle.com>
Date: Tue, 30 Jun 2015 16:53:36 +0100
Patch-mainline: 4.2
Git-commit: ad9ee2053f3f2babebc09ebc4970daa66c56c7ee
References: bnc#942688
Subject: [PATCH] Btrfs: fix hang when failing to submit bio of directIO

The hang is uncoverd by generic/019.

btrfs_endio_direct_write() skips the "finish_ordered_fn" part when it hits
an error, thus those added ordered extents will never get processed, which
block processes that waiting for them via btrfs_start_ordered_extent().

This fixes the above, and meanwhile finish_ordered_fn will do the space
accounting work.

Signed-off-by: Liu Bo <bo.li.liu@oracle.com>
Reviewed-by: Filipe Manana <fdmanana@suse.com>
Tested-by: Filipe Manana <fdmanana@suse.com>
Signed-off-by: Filipe Manana <fdmanana@suse.com>
---
 fs/btrfs/inode.c | 3 ---
 1 file changed, 3 deletions(-)

diff --git a/fs/btrfs/inode.c b/fs/btrfs/inode.c
index 145448d..2e8ce88 100644
--- a/fs/btrfs/inode.c
+++ b/fs/btrfs/inode.c
@@ -6942,8 +6942,6 @@ static void btrfs_endio_direct_write(struct bio *bio, int err)
 	u64 ordered_bytes = dip->bytes;
 	int ret;
 
-	if (err)
-		goto out_done;
 again:
 	ret = btrfs_dec_test_first_ordered_pending(inode, &ordered,
 						   &ordered_offset,
@@ -6966,7 +6964,6 @@ out_test:
 		ordered = NULL;
 		goto again;
 	}
-out_done:
 	bio->bi_private = dip->private;
 
 	kfree(dip);
-- 
1.8.4.5

