From: "Yan, Zheng" <zyan@redhat.com>
Date: Tue, 3 May 2016 22:33:20 +0800
Subject: ceph: fix dir_auth check in ceph_fill_dirfrag()
Git-commit: 421721195a68f46a8218c664154076b5b06f5f51
Patch-mainline: v4.7-rc1
References: FATE#322288

-1 is CDIR_AUTH_PARENT, it means dir's auth mds is the same as
inode's auth mds

Signed-off-by: Yan, Zheng <zyan@redhat.com>
Acked-by: Luis Henriques <lhenriques@suse.com>
---
 fs/ceph/inode.c | 3 +++
 1 file changed, 3 insertions(+)

diff --git a/fs/ceph/inode.c b/fs/ceph/inode.c
index d91eb6b49259..562f57d15f46 100644
--- a/fs/ceph/inode.c
+++ b/fs/ceph/inode.c
@@ -254,6 +254,9 @@ static int ceph_fill_dirfrag(struct inode *inode,
 		diri_auth = ci->i_auth_cap->mds;
 	spin_unlock(&ci->i_ceph_lock);
 
+	if (mds == -1) /* CDIR_AUTH_PARENT */
+		mds = diri_auth;
+
 	mutex_lock(&ci->i_fragtree_mutex);
 	if (ndist == 0 && mds == diri_auth) {
 		/* no delegation info needed. */

