From: Borislav Petkov <bp@suse.de>
Subject: x86/microcode: Rescan feature flags upon late loading
Patch-mainline: Not yet, under development
References: bsc#1075994 bsc#1075091

... so that /proc/cpuinfo mirrors the proper settings.

Signed-off-by: Borislav Petkov <bp@suse.de>

---
 arch/x86/kernel/microcode_core.c |    3 +++
 1 file changed, 3 insertions(+)

--- a/arch/x86/kernel/microcode_core.c
+++ b/arch/x86/kernel/microcode_core.c
@@ -89,6 +89,8 @@
 #include <asm/perf_event.h>
 #include <asm/spec_ctrl.h>
 
+#include "cpu/cpu.h"
+
 MODULE_DESCRIPTION("Microcode Update Driver");
 MODULE_AUTHOR("Tigran Aivazian <tigran@aivazian.fsnet.co.uk>");
 MODULE_LICENSE("GPL");
@@ -325,6 +327,7 @@ static ssize_t reload_store(struct sys_d
 	if (!ret) {
 		perf_check_microcode();
 		x86_spec_check();
+		cpu_caps_sync_late();
 	}
 
 	mutex_unlock(&microcode_mutex);
