From: Ilya Dryomov <idryomov@gmail.com>
Date: Tue, 26 Apr 2016 15:39:47 +0200
Subject: libceph: grab snapc in ceph_osdc_alloc_request()
Git-commit: 841272825b2263174120ab02b4abac9005ee1420
Patch-mainline: v4.7-rc1
References: FATE#322288

ceph_osdc_build_request() is going away.  Grab snapc and initialize
->r_snapid in ceph_osdc_alloc_request().

Signed-off-by: Ilya Dryomov <idryomov@gmail.com>
Acked-by: Luis Henriques <lhenriques@suse.com>
---
 net/ceph/osd_client.c | 6 ++++--
 1 file changed, 4 insertions(+), 2 deletions(-)

diff --git a/net/ceph/osd_client.c b/net/ceph/osd_client.c
index cacce9e35f08..ccb9539dc780 100644
--- a/net/ceph/osd_client.c
+++ b/net/ceph/osd_client.c
@@ -391,6 +391,8 @@ struct ceph_osd_request *ceph_osdc_alloc_request(struct ceph_osd_client *osdc,
 	req->r_osdc = osdc;
 	req->r_mempool = use_mempool;
 	req->r_num_ops = num_ops;
+	req->r_snapid = CEPH_NOSNAP;
+	req->r_snapc = ceph_get_snap_context(snapc);
 
 	kref_init(&req->r_kref);
 	init_completion(&req->r_completion);
@@ -2457,7 +2459,7 @@ void ceph_osdc_build_request(struct ceph_osd_request *req, u64 off,
 	unsigned int i;
 
 	req->r_snapid = snap_id;
-	req->r_snapc = ceph_get_snap_context(snapc);
+	WARN_ON(snapc != req->r_snapc);
 
 	/* encode request */
 	msg->hdr.version = cpu_to_le16(4);
@@ -2508,7 +2510,7 @@ void ceph_osdc_build_request(struct ceph_osd_request *req, u64 off,
 	ceph_encode_64(&p, req->r_snapc ? req->r_snapc->seq : 0);
 	ceph_encode_32(&p, req->r_snapc ? req->r_snapc->num_snaps : 0);
 	if (req->r_snapc) {
-		for (i = 0; i < snapc->num_snaps; i++) {
+		for (i = 0; i < req->r_snapc->num_snaps; i++) {
 			ceph_encode_64(&p, req->r_snapc->snaps[i]);
 		}
 	}

