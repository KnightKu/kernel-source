From 26f271bb6932ccd5fa76e372904a7c8c5c365d2c Mon Sep 17 00:00:00 2001
From: Joerg Roedel <jroedel@suse.de>
Date: Tue, 13 Mar 2018 15:26:35 +0100
Subject: [PATCH 15/17] x86/vdso: Map compat_vdso for user-space when KAISER is
 enabled
References: bsc#1068032 CVE-2017-5754
Patch-mainline: No, different upstream implementation

Make sure the vdso page is mapped in the user-space
page-table when KAISER is enabled.

Signed-off-by: Joerg Roedel <jroedel@suse.de>
---
 arch/x86/vdso/vdso32-setup.c | 7 +++++++
 1 file changed, 7 insertions(+)

diff --git a/arch/x86/vdso/vdso32-setup.c b/arch/x86/vdso/vdso32-setup.c
index f2d6920..ed7fc62 100644
--- a/arch/x86/vdso/vdso32-setup.c
+++ b/arch/x86/vdso/vdso32-setup.c
@@ -25,6 +25,7 @@
 #include <asm/tlbflush.h>
 #include <asm/vdso.h>
 #include <asm/proto.h>
+#include <asm/kaiser.h>
 
 enum {
 	VDSO_DISABLED = 0,
@@ -274,6 +275,12 @@ static void map_compat_vdso(int map)
 	__set_fixmap(FIX_VDSO, page_to_pfn(vdso32_pages[0]) << PAGE_SHIFT,
 		     map ? PAGE_READONLY_EXEC : PAGE_NONE);
 
+#ifdef CONFIG_KAISER
+	kaiser_add_mapping(VDSO_HIGH_BASE, PAGE_SIZE,
+			   map ? __PAGE_KERNEL_VSYSCALL :
+			         (_PAGE_PROTNONE | _PAGE_ACCESSED));
+#endif
+
 	/* flush stray tlbs */
 	flush_tlb_all();
 }
-- 
1.8.5.6

