From: Borislav Petkov <bp@suse.de>
Date: Sat, 16 Dec 2017 17:50:52 +0100
Subject: x86/spec: Add IBRS control functions
Patch-mainline: submitted on 2018/1/9
References: bsc#1068032

... into a separate compilation unit.

Carved out from a patch by Tim Chen <tim.c.chen@linux.intel.com>.

Signed-off-by: Borislav Petkov <bp@suse.de>
---
 arch/x86/include/asm/spec_ctrl.h |    3 +++
 arch/x86/kernel/cpu/Makefile     |    1 +
 arch/x86/kernel/cpu/spec_ctrl.c  |   23 +++++++++++++++++++++++
 3 files changed, 27 insertions(+)

--- a/arch/x86/include/asm/spec_ctrl.h
+++ b/arch/x86/include/asm/spec_ctrl.h
@@ -50,5 +50,8 @@
 .Lend_\@:
 .endm
 
+#else /* __ASSEMBLY__ */
+void x86_enable_ibrs(void);
+void x86_disable_ibrs(void);
 #endif /* __ASSEMBLY__ */
 #endif /* _ASM_X86_SPEC_CTRL_H */
--- a/arch/x86/kernel/cpu/Makefile
+++ b/arch/x86/kernel/cpu/Makefile
@@ -16,6 +16,7 @@ obj-y			:= intel_cacheinfo.o scattered.o
 obj-y			+= proc.o capflags.o powerflags.o common.o
 obj-y			+= vmware.o hypervisor.o sched.o mshyperv.o
 obj-y			+= rdrand.o
+obj-y			+= spec_ctrl.o
 
 obj-$(CONFIG_X86_32)	+= bugs.o
 obj-$(CONFIG_X86_64)	+= bugs_64.o
--- /dev/null
+++ b/arch/x86/kernel/cpu/spec_ctrl.c
@@ -0,0 +1,23 @@
+/*
+ * Speculation control stuff
+ *
+ */
+#include <linux/module.h>
+
+#include <asm/msr.h>
+#include <asm/processor.h>
+#include <asm/spec_ctrl.h>
+
+void x86_disable_ibrs(void)
+{
+	if (boot_cpu_has(X86_FEATURE_SPEC_CTRL))
+		native_wrmsrl(MSR_IA32_SPEC_CTRL, 0);
+}
+EXPORT_SYMBOL_GPL(x86_disable_ibrs);
+
+void x86_enable_ibrs(void)
+{
+	if (boot_cpu_has(X86_FEATURE_SPEC_CTRL))
+		native_wrmsrl(MSR_IA32_SPEC_CTRL, FEATURE_ENABLE_IBRS);
+}
+EXPORT_SYMBOL_GPL(x86_enable_ibrs);
