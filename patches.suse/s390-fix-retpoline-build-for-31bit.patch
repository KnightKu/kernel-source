From: Johannes Thumshirn <jthumshirn@suse.de>
Date: Wed 16 May 13:31:58 CEST 2018
Subject: s390: fix retpoline build on 31bit
References: bsc#1089386
Patch-mainline: Never, SLE11-SP4 specific

Fix build of retpoline code on 31Bit s/390.

Signed-off-by: Johannes Thumshirn <jthumshirn@suse.de>
---
 arch/s390/include/asm/system.h |    2 ++
 arch/s390/kernel/setup.c       |    3 +++
 arch/s390/kernel/smp.c         |    2 ++
 3 files changed, 7 insertions(+)

--- a/arch/s390/include/asm/system.h
+++ b/arch/s390/include/asm/system.h
@@ -185,6 +185,7 @@ static inline void gmb(void)
 }
 #define gmb gmb
 
+#ifdef CONFIG_64BIT
 /**
  * array_index_mask_nospec - generate a mask for array_idx() that is
  * ~0UL when the bounds check succeeds and 0 otherwise
@@ -208,6 +209,7 @@ static inline unsigned long array_index_
 	    :"=d" (mask) : "d" (size), "d" (index) :"cc");
 	return ~mask;
 }
+#endif
 
 #define eieio()	asm volatile("bcr 15,0" : : : "memory")
 #define SYNC_OTHER_CORES(x)   eieio()
--- a/arch/s390/kernel/setup.c
+++ b/arch/s390/kernel/setup.c
@@ -435,7 +435,10 @@ setup_lowcore(void)
 #ifdef CONFIG_SMP
 	lc->spinlock_lockval = arch_spin_lockval(0);
 #endif
+
+#ifdef CONFIG_64BIT
 	lc->br_r1_trampoline = 0x07f1;	/* br %r1 */
+#endif
 
 	set_prefix((u32)(unsigned long) lc);
 	lowcore_ptr[0] = lc;
--- a/arch/s390/kernel/smp.c
+++ b/arch/s390/kernel/smp.c
@@ -705,7 +705,9 @@ int __cpuinit __cpu_up(unsigned int cpu)
 	cpu_lowcore->current_task = (unsigned long) idle;
 	cpu_lowcore->cpu_nr = cpu;
 	cpu_lowcore->spinlock_lockval = arch_spin_lockval(cpu);
+#ifdef CONFIG_64BIT
 	cpu_lowcore->br_r1_trampoline = 0x07f1;	/* br %r1 */
+#endif
 	cpu_lowcore->kernel_asce = S390_lowcore.kernel_asce;
 	cpu_lowcore->machine_flags = S390_lowcore.machine_flags;
 	cpu_lowcore->ftrace_func = S390_lowcore.ftrace_func;
