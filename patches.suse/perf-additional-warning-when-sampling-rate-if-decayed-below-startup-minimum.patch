From: Tony Jones <tonyj@suse.de>
Subject: Additional warning when sampling rate if decayed below startup minimum
References: none
Patch-mainline: never,  see description below

Performance of the dwarf unwinder for call-graphs (perf record -g) will likely 
cause commit 14c63f17b1fde5a575a28e96547a22b451c71fb5 to decay the sampling 
rate below the minimum for perf record (4000).  Issue a warning in this case.

This a is temporary warning (documented in SLE12 release notes).  Intent is to 
fix underlying performance issue as soon as possible and remove this message.

---
 kernel/events/core.c |    6 ++++++
 1 file changed, 6 insertions(+)

--- a/kernel/events/core.c
+++ b/kernel/events/core.c
@@ -268,6 +268,12 @@ void perf_sample_event_took(u64 sample_l
 			atomic_read(&perf_sample_allowed_ns),
 			sysctl_perf_event_sample_rate);
 
+	if (sysctl_perf_event_sample_rate < 4000) {
+		printk_ratelimited(KERN_WARNING
+			"Subsequent perf sampling commands (record) will fail unless frequency <= %d is specified (via -F). "
+			"To disable this warning 'echo 0 > /proc/sys/kernel/perf_cpu_time_max_percent'\n", sysctl_perf_event_sample_rate);
+	}
+
 	update_perf_cpu_limits();
 }
 
